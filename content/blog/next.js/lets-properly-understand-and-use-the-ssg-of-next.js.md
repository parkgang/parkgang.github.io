---
title: next.js의 SSG 제대로 이해하고 사용하기
date: 2021-09-07 00:09:55
category: next.js
thumbnail: { thumbnailSrc }
draft: false
---

# Intro

next.js를 추천할 때 가장 자랑하는 부분이 SSR를 지원한다! 인데 내가 아는 SSR은 Server Side에서 각 페이지 별로 html을 생성해서 Response (혹은 파일 서빙) 을 해주는 것인데 next.js를 공부하고 사용해보면서 이부분에서 아직 찝찝한 부분이 있어서 next.js도 그렇게 동작하는게 맞는가? 에 대한 의문이 항상있었습니다.

> 물론 SSR 단어 뜻 그대로 서버 측에서 렌더링 한다라는 뜻을 의미하지만 필자는 계속 JSP 같은 전통적인 SSR와 엄청 햇갈렸습니다.

그동안 CRA 환경 즉, SPA에서 개발을 하고 있었는데 갑자기 next.js의 원리에 대해 궁금해서 이참에 다시 정리를 해보면서 얻은 경험치에 대해 공유해보려고 합니다.

그럼 SPA를 가공할 수 있는 여러 형태라고 할 수 있는 CSR, SSG, SSR를 비교하면서 설명해보도록 하겠습니다.

> 추가적으로 해당 글에서는 SPA, CSR, SSG, SSR과 같은 단어 설명과 next.js에 대한 설명을 포함하고 있지 않습니다.

# 내가 알고 있던 SSR은?

필자는 SSR를 들었을 때 가장 처음으로 떠오른 것은 jsp 이였습니다.

Client가 요청한 페이지를 Server Side에서 열심히 가공해서 Response 하는 것을 말이죠

이는 주로 SSR를 설명할 때 가장 많이 소개되는 시나리오로 다른 페이지로 넘어갈 때 페이지의 내용을 새로 가공해서 넘겨주기 때문에 **화면이 깜빡** 한다 라고 하는 그 메커니즘을 가진 친구입니다.

근데 next.js 해보면 SSR임에 불구하고 아주 부드럽게 CSR처럼 화면 전환이 이뤄지는 것을 볼 수 있습니다.

> <q>어라...? 내가 뭔가 잘못 이해했구나...</q>

## 그런데 어떻게 전역 상태가 관리되는 거지?

이뿐만이 아니라 위에 내가 알고 있는 SSR을 대입하면 전역 상태는 어떻게 관리되는 건지 의문이 생깁니다.

이동하는 매 페이지는 다른 html인데 전역 상태가 불가능 할 것입니다.  
하지만 next.js는 SSR임에 불구하고 잘 처리됩니다.

사실 next.js only SSR이 아닌 CSR과 SSR의 장점을 섞은 방식인 것을 알 수 있습니다.  
그럼에도 불구하고 SSR 단어는 계속 이전 개념과 충돌하게 되었습니다.

혹시라도 저와 같으신 분이 있다면 해당 글로 이해가 풀리셨으면 좋겠습니다.

# 그럼 next.js의 SSR은 어떻게 작동하는거야?

<!-- 일부로 ### 입니다 ##으로 하니까 글씨가 너무 크게 나와서 별로입니다ㅠㅠ -->

### TL;DR

1. next.js에서 말하는 SSR도 사실 하나 뿐인 SPA으로 동작합니다.
1. 다만, empty html의 SPA 형태가 아닌 Server Side에서 미리 가공된 html을 가지고 SPA으로 동작합니다.

가장 햇갈리고 오해하기 쉬운 것이 SSG, SSR 개념이 들어가니 모든 페이지가 정적으로 구어져있고 페이지 이동마다 Server Side에서 구어진 파일을 응답해서 탐색하겟지? 일 수 있습니다.

하지만 아닙니다! <ins>**첫 요청하는 페이지에 대해서만**</ins> SSG 혹은 SSR으로 Server Side에서 미리 구어 놓은 파일을 응답하는 것이고 그 이후부터는 router를 통해 이동하는 것은 CSR 입니다.

사실 next.js에서 말하는 SSG와 SSR은 Server Side에서 build 시점에 구어 줄까?<sup>SSG</sup> 아님 요청마다 구어 줄까?<sup>SSR</sup> 라고 봐도 무방합니다.

결국에는 첫 요청하는 페이지만 Server Side에서 구어진 파일을 사용하고 이후 부터는 CSR입니다.

그렇기 때문에 전역 상태와 같은 것이 가능한 것입니다. 첫 요청한 페이지를 SPA 삼아서 CSR를 하기 때문이죠 마치 다른 페이지로 이동하면 다른 구어진 파일을 사용했구나 싶을 수 있지만 사실 CSR으로 이동 중 인 것입니다.

> 물론 이동한 경로에서 새로고침을 하면 해당 URL 기준으로 다시 구어진 파일을 받겠지만요

그래서 next.js의 SSR를 설명할 때 SSG와 SSR를 빼고 설명하기가 참 어려운 거 같습니다.

이 때문에 next.js에서 말하는 SSR을 말 그대로 Server Side에서 처리하는 렌더링이라고 생각하시는게 이해에 좋습니다.

> 참고로 next.js의 Pre Rendering 시스템은 기본적으로 SSG으로 동작하며 Server Side에서 build시 기본 파일을 구어내고 매 요청마다 재사용하게 됩니다.

# 한번 해보자

1. 해당 글을 위해서 따로 소스 코드를 생성할 까 싶었지만 사전에 미리 SSG를 테스트 하면서 이용 된 [정적으로 렌더링된 Next.js 웹 사이트 배포](https://docs.microsoft.com/ko-kr/azure/static-web-apps/deploy-nextjs) 템플릿이 글에 사용할 수 있어서 해당 템플릿 코드에서 여러 시나리오를 테스트 할 수 있도록 수정하였습니다. 수정 된 코드는 []() 를 참고하시면 됩니다.
1. 일부로 express 코드도 공식문서와 동일하게 맞춰놓았습니다.
1. 코드 상태는 정말 안좋으므로 이렇게 돌아가는 가는구나 라고만 이해하세요. 그냥 완전 대충 코딩함

1. 덕분에 serverless 상태로 가능한거 게츠비랑 비교해서 자랑 ㄱㄱ

> 코드 리딩이 쉽도록요!

## 왜 파일시스템에서는 안되는 걸까?

1. build된 파일을 보니까 `/` 으로 절대경로로 지정되었기 때문을 설명

## express server

1. express으로 하니까 잘되는거 설명
1. 도메인의 하위 경로를 바꾸고 싶다면 아래와 같이 하면 됩니다.

## 생성되지 않은 동적경로의 경우는?

1. html 파일이 없어서 404 응답되는거 설명
1. 근데 `next export` 으로 사용한다는 것은 블로그와 같이 정말 정적인 데이터인 경우 사용하는 시나리오가 많을 꺼 같아서 이와 같은 시나리오의 경우 는 매우 희박할 것이라고 생각

# 사용을 추천하지 않는 `exportPathMap`

1. `getStatucProps()` 인가 그거 때문에 이제 사용안된다고 그거 설명
1. github issue로도 open되어 있는 상태
1. 이거 제대로 설명해준 사람도 거의 없고 공식문서도 이래서 시간 하루 날려버림... 화남
1. 동적 경로에서 `getStaticProps()` 사용만 하더라도 `getStaticPaths()` 이거 처리 안해서 뭐라고 하는거 증거자료로 서술

# 마무리

1. 사실 제대로 next.js를 많이 사용하고 공부 헀다면 이런 질문이 나오지 않을 수 있다고 생각한다.
1. 하지만 그럼에도 불구하고 next.js의 SSR을 햇갈려하는 글은 간간히 보이는 걸로 보아 나만 그런건 아닌가 싶은 안심이 들기는 하네요
1. 특히, jsp와 같은 Server Side Script 언어와 대조를 하다보니 더욱더 햇갈렸습니다.
1. 보통 블로그와 같이 정적웹을 만든다고 하면 `Gatsby.js` 가 주로 생각나고 많이 사용되는 것으로 알고 있는데 차란히 next.js로 SSG, SSR으 모두 처리하는게 더 좋지 아늘까? 하면서 더 궁금해서 SSG를 더 찾아보았습니다.
